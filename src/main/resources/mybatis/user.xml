<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cbec.b2b.mapper.UserMapper">
	<select id="validate" resultType="com.cbec.b2b.entity.response.LoginResponseEntity">
		SELECT 
			t1.usercode as userId,t2.role_name as currentAuthority
		FROM 
			t_user_list t1,t_sys_role t2,t_user_role t3 
		WHERE 
			t1.id=t3.user_id AND t2.role_id=t3.role_id AND
			t1.usercode=#{account} AND t1.pwd=#{password}
	</select>
	
	<select id="isAuth" resultType="java.lang.Integer">
		SELECT 
			COUNT(*)
		FROM 
			t_user_list t1,t_api_menu t2,t_sys_role t3,t_api_menu_role t4,t_user_role t5
		WHERE 
			t1.id=t5.user_id AND t2.menu_id=t4.menu_id AND t3.role_id=t5.role_id AND t3.role_id=t4.role_id
			AND t1.usercode=#{account} AND t2.menu_url=#{url}
	</select>
	
	<select id="getUser" resultType="com.cbec.b2b.entity.response.CurrentUser">
		SELECT 
			l.username AS `name`,l.avatar AS avatar,l.usercode AS userid,s.notifyCount AS notifyCount
		FROM 
			t_user_list l,
			(SELECT 
				COUNT(*) AS notifyCount
			FROM 
				t_user_list t1,t_user_message t2
			WHERE 
				t1.id=t2.userid AND t1.usercode=#{account} AND t2.`status`='0') s
		WHERE 
			l.usercode=#{account}
	</select>
	
	<resultMap type="com.cbec.b2b.entity.menu.Menu" id="MenuMap">
        <id column="id" property="id"/>
        <collection property="children" ofType="com.cbec.b2b.entity.menu.MenuChildren" column="id" select="getMenuChildren">
        	<result column="menuName" property="name"/>
	        <result column="menuUrl" property="path"/>
	    </collection>  
        
    </resultMap>
    
	<select id="getMenuTop" resultMap="MenuMap">
		SELECT 
			t1.id,t1.menuName AS `name`,t1.icon,t1.menuUrl AS path
		FROM 
			t_sys_menu t1,t_user_list t2,t_sys_role t3,t_user_role t4,t_sys_menu_role t5
		WHERE 
			t2.id= t4.user_id and t1.id = t5.menu_id and t3.role_id = t4.role_id and t3.role_id = t5.role_id 
            AND t1.menuPid=0 and t2.usercode = #{account}
   		ORDER BY t1.sort asc
	</select>
	
	<select id="getMenuChildren" resultType="com.cbec.b2b.entity.menu.MenuChildren">
		SELECT 
			t1.menuName AS `name` ,t1.menuUrl AS path
		FROM 
			t_sys_menu t1,t_user_list t2,t_sys_role t3,t_user_role t4,t_sys_menu_role t5
		WHERE 
			t2.id= t4.user_id and t1.id = t5.menu_id and t3.role_id = t4.role_id and t3.role_id = t5.role_id 
            AND t1.menuPid=1 and t1.parent=#{id}
   		ORDER BY t1.sort asc
	</select>
	
	<select id="getMessageByUserCode" resultType="com.cbec.b2b.entity.message.MessageEntity">
		SELECT 
			t2.id,t2.sendimg AS avatar,t2.title,t2.sendTime AS datetime,t2.messagetype AS `type`
		FROM 
			t_user_list t1,t_user_message t2
		WHERE 
			t1.id=t2.userid AND t1.usercode=#{account} AND t2.`status`='0'
		ORDER BY t2.sendTime DESC
	</select>
	
	<update id="updateMessageByUserCodeType"  parameterType="java.lang.String">  
        UPDATE 
			t_user_message m,
			(SELECT 
					t2.id
				FROM 
					t_user_list t1,t_user_message t2
				WHERE 
					t1.id=t2.userid AND t1.usercode=#{account} AND t2.`status`='0' AND t2.messagetype=#{type}
				ORDER BY t2.sendTime DESC) t
		SET 
			m.status='1'
		WHERE
			m.id=t.id
</update>
</mapper>